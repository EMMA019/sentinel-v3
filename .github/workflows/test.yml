#!/usr/bin/env python3
"""
test.py
GitHub Actions ç”¨ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
generate_backtest.py ã‚’å‘¼ã³å‡ºã—ã€
backtest.json ã‚’ç¢ºå®Ÿã«ç”Ÿæˆã™ã‚‹
"""

import os
import sys
import json
from pathlib import Path
from datetime import datetime

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# APIã‚­ãƒ¼ç¢ºèª
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

api_key = os.getenv("FMP_API_KEY")
if not api_key:
    print("âŒ FMP_API_KEY not set")
    sys.exit(1)

print("âœ… FMP_API_KEY detected")

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ãƒ‘ã‚¹èª¿æ•´
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

BASE_DIR = Path(__file__).resolve().parent.parent
sys.path.append(str(BASE_DIR))

BACKTEST_SCRIPT = BASE_DIR / "scripts" / "generate_backtest.py"
OUTPUT_JSON = BASE_DIR / "frontend" / "public" / "content" / "backtest.json"

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

print("ğŸš€ Running backtest...")

exit_code = os.system(f"python {BACKTEST_SCRIPT}")

if exit_code != 0:
    print("âŒ Backtest failed")
    sys.exit(1)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# JSONç¢ºèª
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

if not OUTPUT_JSON.exists():
    print("âŒ backtest.json not found")
    sys.exit(1)

try:
    with open(OUTPUT_JSON, "r", encoding="utf-8") as f:
        data = json.load(f)

    print("ğŸ“Š Backtest Summary:")
    print(json.dumps({
        "generated_at": data.get("generated_at"),
        "overall": data.get("overall"),
        "methods": data.get("methods")
    }, indent=2, ensure_ascii=False))

except Exception as e:
    print(f"âŒ Failed to read JSON: {e}")
    sys.exit(1)

print("âœ… Backtest JSON successfully generated")